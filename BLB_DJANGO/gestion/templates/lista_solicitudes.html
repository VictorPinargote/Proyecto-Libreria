{% extends "index.html" %}

{% block contenido %}
<div class="col-12">
    <!-- Solicitudes Pendientes -->
    <div class="card shadow border-0 rounded-4 mb-4">
        <div class="card-header text-white py-4" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <h3 class="mb-0 fw-bold">
                <i class="bi bi-hourglass-split me-2"></i>Solicitudes Pendientes
                <span class="badge bg-light text-dark ms-2">{{ solicitudes_pendientes|length }}</span>
            </h3>
        </div>
        <div class="card-body p-4">
            {% if solicitudes_pendientes %}
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Usuario</th>
                            <th>Libro</th>
                            <th>Días</th>
                            <th>Fecha Solicitud</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for solicitud in solicitudes_pendientes %}
                        <tr>
                            <td>
                                <strong>{{ solicitud.usuario.first_name }} {{ solicitud.usuario.last_name }}</strong>
                                <br><small class="text-muted">@{{ solicitud.usuario.username }}</small>
                            </td>
                            <td>
                                <strong>{{ solicitud.libro.titulo }}</strong>
                                <br><small class="text-muted">{{ solicitud.libro.autor }}</small>
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ solicitud.dias_solicitados }} días</span>
                            </td>
                            <td>{{ solicitud.fecha_solicitud|date:"d/m/Y H:i" }}</td>
                            <td>
                                <div class="btn-group" role="group">
                                    <form method="POST" action="{% url 'aprobar_solicitud' solicitud.id %}"
                                        class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-success btn-sm rounded-start">
                                            <i class="bi bi-check-lg me-1"></i>Aprobar
                                        </button>
                                    </form>
                                    <button type="button" class="btn btn-danger btn-sm rounded-end"
                                        data-bs-toggle="modal" data-bs-target="#rechazarModal{{ solicitud.id }}">
                                        <i class="bi bi-x-lg me-1"></i>Rechazar
                                    </button>
                                </div>

                                <!-- Modal para rechazar -->
                                <div class="modal fade" id="rechazarModal{{ solicitud.id }}" tabindex="-1">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <form method="POST" action="{% url 'rechazar_solicitud' solicitud.id %}">
                                                {% csrf_token %}
                                                <div class="modal-header bg-danger text-white">
                                                    <h5 class="modal-title">
                                                        <i class="bi bi-x-circle me-2"></i>Rechazar Solicitud
                                                    </h5>
                                                    <button type="button" class="btn-close btn-close-white"
                                                        data-bs-dismiss="modal"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <p>¿Estás seguro de rechazar la solicitud de <strong>{{
                                                            solicitud.usuario.first_name }}</strong>
                                                        para el libro <strong>{{ solicitud.libro.titulo }}</strong>?</p>
                                                    <div class="mb-3">
                                                        <label class="form-label">Motivo del rechazo:</label>
                                                        <textarea name="motivo" class="form-control" rows="3"
                                                            placeholder="Explica el motivo del rechazo..."></textarea>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary"
                                                        data-bs-dismiss="modal">Cancelar</button>
                                                    <button type="submit" class="btn btn-danger">
                                                        <i class="bi bi-x-circle me-1"></i>Rechazar
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="bi bi-check-circle display-4 text-success"></i>
                <h5 class="mt-3 text-muted">No hay solicitudes pendientes</h5>
                <p class="text-muted">Todas las solicitudes han sido procesadas</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Historial de Solicitudes Procesadas -->
    <div class="card shadow border-0 rounded-4">
        <div class="card-header py-3 bg-light">
            <h5 class="mb-0">
                <i class="bi bi-clock-history me-2"></i>Historial Reciente
            </h5>
        </div>
        <div class="card-body p-4">
            {% if solicitudes_procesadas %}
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Libro</th>
                            <th>Estado</th>
                            <th>Procesado por</th>
                            <th>Fecha</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for solicitud in solicitudes_procesadas %}
                        <tr>
                            <td>{{ solicitud.usuario.username }}</td>
                            <td>{{ solicitud.libro.titulo }}</td>
                            <td>
                                {% if solicitud.estado == 'aprobada' %}
                                <span class="badge bg-success">Aprobada</span>
                                {% else %}
                                <span class="badge bg-danger">Rechazada</span>
                                {% endif %}
                            </td>
                            <td>{{ solicitud.respondido_por.username|default:"-" }}</td>
                            <td>{{ solicitud.fecha_respuesta|date:"d/m/Y" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted text-center mb-0">No hay historial aún</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}